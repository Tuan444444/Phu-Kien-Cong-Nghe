@model PhuKienCongNghe.ViewModels.DashboardViewModel
@{
    ViewData["Title"] = "Bảng điều khiển";
    Layout = "_AdminLayout";
}

<h1 class="mb-4">@ViewData["Title"]</h1>

<div class="row">
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100 card-stats">
            <div class="card-body"><div class="row no-gutters align-items-center"><div class="col me-2"><div class="text-xs fw-bold text-primary text-uppercase mb-1">Doanh thu (Tháng này)</div><div class="h5 mb-0 fw-bold text-gray-800">@Model.DoanhThuThangNay.ToString("N0") đ</div></div><div class="col-auto"><div class="icon-circle bg-primary"><i class="bi bi-cash-stack fs-4 text-white"></i></div></div></div></div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100 card-stats">
            <div class="card-body"><div class="row no-gutters align-items-center"><div class="col me-2"><div class="text-xs fw-bold text-warning text-uppercase mb-1">Đơn hàng mới</div><div class="h5 mb-0 fw-bold text-gray-800">@Model.DonHangMoi</div></div><div class="col-auto"><div class="icon-circle bg-warning"><i class="bi bi-receipt fs-4 text-white"></i></div></div></div></div>
            <a asp-controller="AdminOrders" asp-action="Index" asp-route-status="Chờ xác nhận" class="card-footer text-decoration-none text-muted small">Xem chi tiết <i class="bi bi-arrow-right-circle"></i></a>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100 card-stats">
            <div class="card-body"><div class="row no-gutters align-items-center"><div class="col me-2"><div class="text-xs fw-bold text-success text-uppercase mb-1">Tổng số Khách hàng</div><div class="h5 mb-0 fw-bold text-gray-800">@Model.TongKhachHang</div></div><div class="col-auto"><div class="icon-circle bg-success"><i class="bi bi-people fs-4 text-white"></i></div></div></div></div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100 card-stats">
            <div class="card-body"><div class="row no-gutters align-items-center"><div class="col me-2"><div class="text-xs fw-bold text-danger text-uppercase mb-1">Sắp hết hàng</div><div class="h5 mb-0 fw-bold text-gray-800">@Model.SanPhamSapHetHang</div></div><div class="col-auto"><div class="icon-circle bg-danger"><i class="bi bi-box-seam fs-4 text-white"></i></div></div></div></div>
            <a asp-controller="AdminProduct" asp-action="Index" class="card-footer text-decoration-none text-muted small">Xem chi tiết <i class="bi bi-arrow-right-circle"></i></a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-12">
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                Biểu đồ Doanh thu 30 ngày qua
            </div>
            <div class="card-body" style="min-height: 320px;">
                <canvas id="myRevenueChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-12">
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                Top 5 Sản phẩm bán chạy
            </div>
            <div class="card-body" style="min-height: 320px;" id="topProductsListContainer">
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header">
                Cơ cấu Doanh thu (Theo Danh mục)
            </div>
            <div class="card-body" style="min-height: 320px;">
                <canvas id="myCategoryRevenueChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header">
                Tình trạng Đơn hàng
            </div>
            <div class="card-body" style="min-height: 320px;">
                <canvas id="myOrderStatusChart"></canvas>
            </div>
        </div>
    </div>
</div>


@section Styles {
    <style>
        /* Card Stats Styling */
        .card-stats .card-body {
            padding: 1.5rem;
        }

        .card-stats .text-xs {
            font-size: .8rem;
            letter-spacing: .05em;
        }

        .card-stats .h5 {
            font-size: 1.75rem;
        }

        .icon-circle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            opacity: 0.9;
        }

            .icon-circle.bg-primary {
                background-color: #0d6efd !important;
            }

            .icon-circle.bg-warning {
                background-color: #ffc107 !important;
            }

            .icon-circle.bg-success {
                background-color: #198754 !important;
            }

            .icon-circle.bg-danger {
                background-color: #dc3545 !important;
            }

        .text-gray-800 {
            color: #5a5c69 !important;
        }

        /* General Card Styling */
        .card {
            border: none;
            border-radius: .5rem;
            box-shadow: 0 .15rem 1.75rem 0 rgba(58,59,69,.15) !important;
            transition: transform .2s;
        }

            .card:hover {
                transform: translateY(-2px);
            }

            /* Card Header Styling (Mới) */
            .card .card-header {
                background-color: #f8f9fa;
                border-bottom: 2px solid #e3e6f0;
                padding: 1rem 1.25rem;
                font-size: 0.95rem;
                font-weight: 600;
                color: #495057;
                text-transform: uppercase;
                letter-spacing: .05em;
            }

        /* Top Product List Styling */
        .top-product-list {
            list-style: none;
            padding-left: 0;
            margin-bottom: 0;
        }

            .top-product-list li {
                padding: 10px 0;
                border-bottom: 1px solid #eee;
            }

                .top-product-list li:last-child {
                    border-bottom: none;
                }

        .product-name-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            align-items: flex-start;
        }

        .product-name {
            font-size: 0.9rem;
            color: #5a5c69;
            font-weight: 600;
            white-space: normal;
            word-break: break-word;
            margin-right: 10px;
        }

        .product-sold {
            font-size: 0.85rem;
            color: #858796;
            white-space: nowrap;
        }

        /* Progress Bar Colors */
        .progress-bar {
            background-color: #0d6efd;
        }

            .progress-bar.bg-pink {
                background-color: rgba(255, 99, 132, 0.9);
            }

            .progress-bar.bg-yellow {
                background-color: rgba(255, 206, 86, 0.9);
            }

            .progress-bar.bg-teal {
                background-color: rgba(75, 192, 192, 0.9);
            }

            .progress-bar.bg-purple {
                background-color: rgba(153, 102, 255, 0.9);
            }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function () {

            // --- BIỂU ĐỒ 1: DOANH THU ---
            $.ajax({
                url: '@Url.Action("GetRevenueChartData", "Admin")',
                type: 'GET',
                success: function (result) {
                    const ctx = document.getElementById('myRevenueChart').getContext('2d');
                    new Chart(ctx, { type: 'line', data: { labels: result.labels, datasets: [{ label: 'Doanh thu', data: result.data, borderColor: '#0d6efd', backgroundColor: 'rgba(13, 110, 253, 0.1)', fill: true, tension: 0.3, pointBackgroundColor: '#0d6efd', pointBorderWidth: 2, pointRadius: 4, pointHoverRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: function (value) { return new Intl.NumberFormat('vi-VN').format(value) + ' đ'; } }, grid: { color: 'rgba(0, 0, 0, 0.05)' } }, x: { grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: function (context) { let label = context.dataset.label || ''; if (label) { label += ': '; } if (context.parsed.y !== null) { label += new Intl.NumberFormat('vi-VN').format(context.parsed.y) + ' đ'; } return label; } } } } } });
                }, error: function () {
                    console.log('Lỗi tải biểu đồ Doanh thu.');
                    const ctx_err = document.getElementById('myRevenueChart').getContext('2d');
                    ctx_err.font = "16px Arial"; ctx_err.fillStyle = "red"; ctx_err.textAlign = "center";
                    ctx_err.fillText("Lỗi: Không thể tải dữ liệu.", ctx_err.canvas.width / 2, ctx_err.canvas.height / 2);
                }
            });

            // --- DANH SÁCH 2: TOP SẢN PHẨM ---
            $.ajax({
                url: '@Url.Action("GetTopProductsListData", "Admin")',
                type: 'GET',
                success: function (products) {
                    const barColors = ['', 'bg-pink', 'bg-yellow', 'bg-teal', 'bg-purple'];
                    var container = $('#topProductsListContainer');
                    if (products && products.length > 0) {
                        var html = '<ul class="top-product-list">';
                        $.each(products, function(index, product) {
                            const colorClass = barColors[index % barColors.length];
                            html += '<li>';
                            html += '  <div class="product-name-line">';
                            html += '    <span class="product-name">' + (index + 1) + '. ' + product.tenSanPham + '</span>';
                            html += '    <span class="product-sold">Đã bán: ' + product.soLuongDaBan + '</span>';
                            html += '  </div>';
                            html += '  <div class="progress" style="height: 8px;">';
                            html += '    <div class="progress-bar ' + colorClass + '" role="progressbar" style="width: ' + product.tyLePhanTram + '%" aria-valuenow="' + product.tyLePhanTram + '" aria-valuemin="0" aria-valuemax="100"></div>';
                            html += '  </div>';
                            html += '</li>';
                        });
                        html += '</ul>';
                        container.html(html);
                    } else {
                        container.html('<p class="text-center text-muted mt-5">Chưa có dữ liệu sản phẩm.</p>');
                    }
                },
                error: function () {
                    console.log('Lỗi tải Top Sản phẩm.');
                    $('#topProductsListContainer').html('<p class="text-center text-danger mt-5">Lỗi tải dữ liệu.</p>');
                }
            });

            // --- BIỂU ĐỒ 3: CƠ CẤU DOANH THU ---
            $.ajax({
                url: '@Url.Action("GetCategoryRevenueData", "Admin")',
                type: 'GET',
                success: function (result) {
                    const ctx = document.getElementById('myCategoryRevenueChart').getContext('2d');
                    new Chart(ctx, { type: 'doughnut', data: { labels: result.labels, datasets: [{ label: 'Doanh thu', data: result.data, backgroundColor: ['rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)'], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: function (context) { let label = context.label || ''; let value = context.parsed; return ' ' + label + ': ' + new Intl.NumberFormat('vi-VN').format(value) + ' đ'; } } } } } });
                }, error: function () {
                    console.log('Lỗi tải biểu đồ Doanh thu Danh mục.');
                    const ctx = document.getElementById('myCategoryRevenueChart').getContext('2d');
                    ctx.font = "16px Arial"; ctx.fillStyle = "red"; ctx.textAlign = "center";
                    ctx.fillText("Lỗi: Không thể tải dữ liệu.", ctx.canvas.width / 2, ctx.canvas.height / 2);
                }
            });

            // --- BIỂU ĐỒ 4: TÌNH TRẠNG ĐƠN HÀNG ---
            $.ajax({
                url: '@Url.Action("GetOrderStatusData", "Admin")',
                type: 'GET',
                success: function (result) {
                    const ctx = document.getElementById('myOrderStatusChart').getContext('2d');
                    const myOrderStatusChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: result.labels,
                            datasets: [{
                                label: 'Số lượng',
                                data: result.data,
                                backgroundColor: [
                                    'rgba(25, 135, 84, 0.7)',  // Hoàn thành
                                    'rgba(255, 193, 7, 0.7)',   // Chờ xác nhận
                                    'rgba(13, 202, 240, 0.7)',  // Đang giao
                                    'rgba(220, 53, 69, 0.7)',   // Đã hủy
                                    'rgba(108, 117, 125, 0.7)'  // Khác
                                ],
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'top' },
                                tooltip: { callbacks: { label: function(context) { let label = context.label || ''; let value = context.parsed; return ' ' + label + ': ' + value + ' đơn'; } } }
                            }
                        }
                    });
                },
                error: function () {
                    console.log('Lỗi tải biểu đồ Tình trạng Đơn hàng.');
                    const ctx = document.getElementById('myOrderStatusChart').getContext('2d');
                    ctx.font = "16px Arial"; ctx.fillStyle = "red"; ctx.textAlign = "center";
                    ctx.fillText("Lỗi: Không thể tải dữ liệu.", ctx.canvas.width / 2, ctx.canvas.height / 2);
                }
            });

        });
    </script>
}