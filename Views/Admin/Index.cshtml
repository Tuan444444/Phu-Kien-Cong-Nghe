@model PhuKienCongNghe.ViewModels.DashboardViewModel
@{
    ViewData["Title"] = "Bảng điều khiển";
    Layout = "_AdminLayout";
}

<h1 class="mb-4">@ViewData["Title"]</h1>

<div class="row">
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100 card-stats">
            <div class="card-body"><div class="row no-gutters align-items-center"><div class="col me-2"><div class="text-xs fw-bold text-primary text-uppercase mb-1">Doanh thu (Tháng này)</div><div class="h5 mb-0 fw-bold text-gray-800">@Model.DoanhThuThangNay.ToString("N0") đ</div></div><div class="col-auto"><div class="icon-circle bg-primary"><i class="bi bi-cash-stack fs-4 text-white"></i></div></div></div></div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100 card-stats">
            <div class="card-body"><div class="row no-gutters align-items-center"><div class="col me-2"><div class="text-xs fw-bold text-warning text-uppercase mb-1">Đơn hàng mới</div><div class="h5 mb-0 fw-bold text-gray-800">@Model.DonHangMoi</div></div><div class="col-auto"><div class="icon-circle bg-warning"><i class="bi bi-receipt fs-4 text-white"></i></div></div></div></div>
            <a asp-controller="AdminOrders" asp-action="Index" asp-route-status="Chờ xác nhận" class="card-footer text-decoration-none text-muted small">Xem chi tiết <i class="bi bi-arrow-right-circle"></i></a>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100 card-stats">
            <div class="card-body"><div class="row no-gutters align-items-center"><div class="col me-2"><div class="text-xs fw-bold text-success text-uppercase mb-1">Tổng số Khách hàng</div><div class="h5 mb-0 fw-bold text-gray-800">@Model.TongKhachHang</div></div><div class="col-auto"><div class="icon-circle bg-success"><i class="bi bi-people fs-4 text-white"></i></div></div></div></div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100 card-stats">
            <div class="card-body"><div class="row no-gutters align-items-center"><div class="col me-2"><div class="text-xs fw-bold text-danger text-uppercase mb-1">Sắp hết hàng</div><div class="h5 mb-0 fw-bold text-gray-800">@Model.SanPhamSapHetHang</div></div><div class="col-auto"><div class="icon-circle bg-danger"><i class="bi bi-box-seam fs-4 text-white"></i></div></div></div></div>
            <a asp-controller="AdminProduct" asp-action="Index" class="card-footer text-decoration-none text-muted small">Xem chi tiết <i class="bi bi-arrow-right-circle"></i></a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-7">
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                Biểu đồ Doanh thu 7 ngày qua
            </div>
            <div class="card-body" style="min-height: 320px;">
                <canvas id="myRevenueChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-5">
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                Top 5 Sản phẩm bán chạy
            </div>
            <div class="card-body" style="min-height: 320px;">
                <canvas id="myTopProductsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header">
                Cơ cấu Doanh thu (Theo Danh mục)
            </div>
            <div class="card-body" style="min-height: 320px;">
                <canvas id="myCategoryRevenueChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header">
                Tình trạng Đơn hàng
            </div>
            <div class="card-body" style="min-height: 320px;">
                <canvas id="myOrderStatusChart"></canvas>
            </div>
        </div>
    </div>
</div>


@section Styles {
    <style>
        .card-stats .card-body {
            padding: 1.5rem;
        }

        .card-stats .text-xs {
            font-size: .8rem;
            letter-spacing: .05em;
        }

        .card-stats .h5 {
            font-size: 1.75rem;
        }

        .icon-circle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            opacity: 0.9;
        }

            .icon-circle.bg-primary {
                background-color: #0d6efd !important;
            }

            .icon-circle.bg-warning {
                background-color: #ffc107 !important;
            }

            .icon-circle.bg-success {
                background-color: #198754 !important;
            }

            .icon-circle.bg-danger {
                background-color: #dc3545 !important;
            }

        .text-gray-800 {
            color: #5a5c69 !important;
        }

        .card {
            border: none;
            border-radius: .5rem;
            box-shadow: 0 .15rem 1.75rem 0 rgba(58,59,69,.15) !important;
            transition: transform .2s;
        }

            .card:hover {
                transform: translateY(-2px);
            }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function () {

            // --- BIỂU ĐỒ 1: DOANH THU (Giữ nguyên) ---
            $.ajax({
                url: '@Url.Action("GetRevenueChartData", "Admin")',
                type: 'GET',
                success: function (result) {
                    const ctx = document.getElementById('myRevenueChart').getContext('2d');
                    new Chart(ctx, { type: 'line', data: { labels: result.labels, datasets: [{ label: 'Doanh thu', data: result.data, borderColor: '#0d6efd', backgroundColor: 'rgba(13, 110, 253, 0.1)', fill: true, tension: 0.3, pointBackgroundColor: '#0d6efd', pointBorderWidth: 2, pointRadius: 4, pointHoverRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: function (value) { return new Intl.NumberFormat('vi-VN').format(value) + ' đ'; } }, grid: { color: 'rgba(0, 0, 0, 0.05)' } }, x: { grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: function (context) { let label = context.dataset.label || ''; if (label) { label += ': '; } if (context.parsed.y !== null) { label += new Intl.NumberFormat('vi-VN').format(context.parsed.y) + ' đ'; } return label; } } } } } });
                }, error: function () { console.log('Lỗi tải biểu đồ Doanh thu.'); }
            });

            // --- BIỂU ĐỒ 2: TOP SẢN PHẨM (Giữ nguyên) ---
            $.ajax({
                url: '@Url.Action("GetTopProductsChartData", "Admin")',
                type: 'GET',
                success: function (result) {
                    const ctx = document.getElementById('myTopProductsChart').getContext('2d');
                    new Chart(ctx, { type: 'bar', data: { labels: result.labels, datasets: [{ label: 'Số lượng bán', data: result.data, backgroundColor: ['rgba(255, 99, 132, 0.5)', 'rgba(54, 162, 235, 0.5)', 'rgba(255, 206, 86, 0.5)', 'rgba(75, 192, 192, 0.5)', 'rgba(153, 102, 255, 0.5)'], borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)'], borderWidth: 1 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' } }, y: { grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: function (context) { return ' Đã bán: ' + context.parsed.x + ' sản phẩm'; } } } } } });
                }, error: function () { console.log('Lỗi tải biểu đồ Top Sản phẩm.'); }
            });

            // --- BIỂU ĐỒ 3: CƠ CẤU DOANH THU (Giữ nguyên) ---
            $.ajax({
                url: '@Url.Action("GetCategoryRevenueData", "Admin")',
                type: 'GET',
                success: function (result) {
                    const ctx = document.getElementById('myCategoryRevenueChart').getContext('2d');
                    new Chart(ctx, { type: 'doughnut', data: { labels: result.labels, datasets: [{ label: 'Doanh thu', data: result.data, backgroundColor: ['rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)'], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: function (context) { let label = context.label || ''; let value = context.parsed; return ' ' + label + ': ' + new Intl.NumberFormat('vi-VN').format(value) + ' đ'; } } } } } });
                }, error: function () {
                    console.log('Lỗi tải biểu đồ Doanh thu Danh mục.');
                    const ctx = document.getElementById('myCategoryRevenueChart').getContext('2d');
                    ctx.font = "16px Arial"; ctx.fillStyle = "red"; ctx.textAlign = "center";
                    ctx.fillText("Lỗi: Không thể tải dữ liệu.", ctx.canvas.width / 2, ctx.canvas.height / 2);
                }
            });

            //
            // --- 4. THÊM MỚI: BIỂU ĐỒ 4: TÌNH TRẠNG ĐƠN HÀNG ---
            //
            $.ajax({
                url: '@Url.Action("GetOrderStatusData", "Admin")', // Gọi hàm mới
                type: 'GET',
                success: function (result) {
                    const ctx = document.getElementById('myOrderStatusChart').getContext('2d');

                    const myOrderStatusChart = new Chart(ctx, {
                        type: 'pie', // Dùng Pie (tròn đặc)
                        data: {
                            labels: result.labels, // Trạng thái (Hoàn thành, Đã hủy...)
                            datasets: [{
                                label: 'Số lượng',
                                data: result.data, // Số lượng đơn
                                backgroundColor: [
                                    'rgba(25, 135, 84, 0.7)',  // Màu xanh lá (Hoàn thành)
                                    'rgba(255, 193, 7, 0.7)',   // Màu vàng (Chờ xác nhận)
                                    'rgba(13, 202, 240, 0.7)',  // Màu xanh lơ (Đang giao)
                                    'rgba(220, 53, 69, 0.7)',   // Màu đỏ (Đã hủy)
                                    'rgba(108, 117, 125, 0.7)'  // Màu xám (Trạng thái khác)
                                ],
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label || '';
                                            let value = context.parsed;
                                            return ' ' + label + ': ' + value + ' đơn';
                                        }
                                    }
                                }
                            }
                        }
                    });
                },
                error: function () {
                    console.log('Lỗi tải biểu đồ Tình trạng Đơn hàng.');
                    const ctx = document.getElementById('myOrderStatusChart').getContext('2d');
                    ctx.font = "16px Arial"; ctx.fillStyle = "red"; ctx.textAlign = "center";
                    ctx.fillText("Lỗi: Không thể tải dữ liệu.", ctx.canvas.width / 2, ctx.canvas.height / 2);
                }
            });

        });
    </script>
}